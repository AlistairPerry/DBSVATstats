function [VATstatsall] = calculateVATstats(STNparcdir)
%UNTITLED Summary of this function goes here
%   Detailed explanation goes here
%inputs

%required software dependencies:
%NBS

%make sure you are within /Lab_MichaelB/PhilM/VAT_Data_New (or another
%folder that contains leadDBS output files)

%setup working and subjects directories
workingdirectory = pwd;
files = dir(workingdirectory);
dirFlags=[files.isdir];
subFolders=files(dirFlags);
subFolders(1:2)=[];

%load in STN parcels

[STNmotorRhdr,STNmotorRdata]=read(['LEAD_DBS_STN_motor_RIGHT.nii']);

[STNmotorLhdr,STNmotorLdata]=read(['LEAD_DBS_STN_motor_LEFT.nii']);

[STNassocLhdr,STNassocLdata]=read(['LEAD_DBS_STN_associative_LEFT.nii']);

[STNassocRhdr,STNassocRdata]=read(['LEAD_DBS_STN_associative_RIGHT.nii']);

[STNlimbicLhdr,STNlimbicLdata]=read(['LEAD_DBS_STN_limbic_LEFT.nii']);

[STNlimbicRhdr,STNlimbicRdata]=read(['LEAD_DBS_STN_limbic_RIGHT.nii']);

%extract their voxels
[STNmotorRvoxs]=find(STNmotorRdata==1);

[STNmotorLvoxs]=find(STNmotorLdata==1);

[STNassocRvoxs]=find(STNassocRdata==1);

[STNassocLvoxs]=find(STNassocLdata==1);

[STNlimbicRvoxs]=find(STNlimbicRdata==1);

[STNlimbicLvoxs]=find(STNlimbicLdata==1);

%load all subjects VATS and extract
for s = 1:length(subFolders)
    VATindivstats=[];
    
    currentSubj= subFolders(s,1).name;
    currentSubjDir = char([workingdirectory '/' currentSubj]);
    
    %parse VAT file strings
    VATsubjids{s,1} = currentSubj;
    SubjRVATfile=[currentSubjDir '/' 'rLEAD_DBS_VAT_RIGHT.nii'];
    [RVAThdr,RVATdata]=read(SubjRVATfile);
    
    SubjLVATfile=[currentSubjDir '/' 'rLEAD_DBS_VAT_LEFT.nii'];
    [LVAThdr,LVATdata]=read(SubjLVATfile);
    
    %calculate proportion of stimulation field in each STN zone
    [r1]=find(RVATdata==1);
    [l1]=find(LVATdata==1);
    
    %Right Motor
    
    cors=ismember(r1,STNmotorRvoxs);
    
    if isempty(cors)
        Rmotoroverlap=0;
        Rmotorperc=0;
    else
        Rmotoroverlap=find(cors==1);
        Rmotorperc=[Rmotoroverlap./length(r1)]*100;
    end
    
    %Left Motor
    
    cors=ismember(l1,STNmotorLvoxs);
    
    if isempty(cors)
        Lmotoroverlap=0;
        Lmotorperc=0;
    else
        Lmotoroverlap=find(cors==1);
        Lmotorperc=[Lmotoroverlap./length(l1)]*100;
    end
    
    %Right Assoc
    
    cors=ismember(r1,STNassocRvoxs);
    
    if isempty(cors)
        Rassocoverlap=0;
        Rassocperc=0;
    else
        Rassocoverlap=find(cors==1);
        Rassocperc=[Rassocoverlap./length(r1)]*100;
    end
    
    %Left Assoc
    
    cors=ismember(l1,STNassocLvoxs);
    
    if isempty(cors)
        Lassocoverlap=0;
        Lassocperc=0;
    else
        Lassocoverlap=find(cors==1);
        Lassocperc=[Lassocoverlap./length(l1)]*100;
    end

%Right Limbic

    cors=ismember(r1,STNlimbicRvoxs);

    if isempty(cors)
    Rlimbicoverlap=0;
    Rlimbicperc=0;
    else
    Rlimbicoverlap=find(cors==1);
    Rlimbicperc=[length(Rlimbicoverlap)./length(STNlimbicRvoxs)]*100;
    end

    %Left Limbic

    cors=ismember(l1,STNlimbicLvoxs);

    if isempty(cors)
    Llimbicoverlap=0;
    Llimbicperc=0;
    else
    Llimbicoverlap=find(cors==1);
    Llimbicperc=[length(Llimbicoverlap)./length(STNlimbicLvoxs)]*100;
    end
    
%Combine individual VAT stats into single matrix    
VATindivstats=cat(2, Rmotorperc, Lmotorperc, Rassocperc, Lassocperc, Rlimbicperc, Llimbicperc);

%And then full subject matrix
VATstatsall(s,:)=VATindivstats;

end

%Now write VAT stats to output matrix

fid = fopen(['VATstats.txt'], 'wt');

fprintf(fid, '%s%s%s%s%s\n', 'ID', 'Rmotorperc','Lmotorperc','Rassocperc','Lassocperc','Rlimbicperc','Llimbicperc');
for s = 1:length(subFolders)
    fprintf(fid, '%s%d\n', VATsubjids{s,1},VATstatsall(:,1),VATstatsall(:,2),VATs);
end
fclose(fid)





end

